# VULNERABILITY_REPORT.md â€” Vulnerabilities & Fixes

## 1) SQL Injection in `UserRepository`
**Before (vulnerable):**
```csharp
var sql = $"SELECT * FROM Users WHERE Email = '{email}'";
var user = await connection.QueryFirstOrDefaultAsync<User>(sql);
```

**After (fixed with parameters):**
```csharp
var sql = "SELECT * FROM Users WHERE Email = @Email";
var user = await connection.QueryFirstOrDefaultAsync<User>(sql, new { Email = email });
```

**Why**: removes injection surface; DB treats input as data, not code.

---

## 2) Reflected XSS in error echo
**Before:**
```csharp
return Content($"Error: {Request.Query["q"]}");
```

**After:**
```csharp
var safe = System.Text.Encodings.Web.HtmlEncoder.Default.Encode(Request.Query["q"]);
return Content($"Error: {safe}");
```

**Why**: encode untrusted data before including in HTML.

---

## 3) Missing RBAC on admin endpoint
**Before:** no authorization attribute.

**After:**
```csharp
[Authorize(Roles = "Admin")]
[HttpPost("admin/rotate-keys")]
public async Task<IActionResult> RotateKeys() { /* ... */ }
```

**Why**: enforce least privilege; protect sensitive operations.

---

## 4) Weak validation on registration
**Before:** no length/format checks on username/email/password.

**After:** data annotations + extra checks (see `RegisterUserDto`).

**Why**: prevent malformed input, resource waste, and abuse vectors.
